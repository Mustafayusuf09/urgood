#!/bin/sh

set -e

echo "ðŸš€ UrGood CI Post-Clone Script"
echo "=============================="

# Print environment info
echo "ðŸ“± Xcode version: $(xcodebuild -version)"
echo "ðŸŽ macOS version: $(sw_vers -productVersion)"
echo "ðŸ“‚ Working directory: $(pwd)"

# Check if we're running in Xcode Cloud
if [ "$CI_XCODE_CLOUD" = "TRUE" ]; then
    echo "âœ… Running in Xcode Cloud"
else
    echo "âš ï¸  Not running in Xcode Cloud (local test)"
fi

# Install dependencies
echo ""
echo "ðŸ“¦ Installing dependencies..."

# Swift Package Manager dependencies are automatically resolved by Xcode Cloud
echo "âœ… Swift Package Manager dependencies will be resolved automatically"

# If you were using CocoaPods, you would uncomment this:
# if [ -f "Podfile" ]; then
#     echo "Installing CocoaPods..."
#     bundle install
#     bundle exec pod install
# fi

# Set up environment variables from Xcode Cloud secrets
echo ""
echo "ðŸ” Setting up environment variables..."

# Create the urgood directory if it doesn't exist (for Secrets.xcconfig)
mkdir -p urgood

# Create Secrets.xcconfig from Xcode Cloud environment variables
cat > urgood/Secrets.xcconfig << EOF
// Auto-generated by Xcode Cloud CI
// Do not commit this file

OPENAI_API_KEY = \${OPENAI_API_KEY}
ELEVENLABS_API_KEY = \${ELEVENLABS_API_KEY}
FIREBASE_CONFIG = \${FIREBASE_CONFIG}
REVENUECAT_API_KEY = \${REVENUECAT_API_KEY}
EOF

echo "âœ… Created Secrets.xcconfig"

# Verify critical files exist
echo ""
echo "ðŸ” Verifying project structure..."

if [ ! -f "urgood/urgood.xcodeproj/project.pbxproj" ]; then
    echo "âŒ ERROR: Xcode project not found!"
    exit 1
fi

if [ ! -f "urgood/urgood/urgoodApp.swift" ]; then
    echo "âŒ ERROR: Main app file not found!"
    exit 1
fi

echo "âœ… Project structure verified"

# Check for GoogleService-Info.plist
echo ""
echo "ðŸ” Checking Firebase configuration..."

if [ ! -f "urgood/urgood/GoogleService-Info.plist" ]; then
    echo "âš ï¸  WARNING: GoogleService-Info.plist not found"
    echo "   This may cause Firebase-related features to fail"
else
    echo "âœ… Firebase configuration found"
fi

# Print available schemes
echo ""
echo "ðŸ“‹ Available schemes:"
xcodebuild -list -project urgood/urgood.xcodeproj

echo ""
echo "âœ… Post-clone setup complete!"
echo "=============================="

