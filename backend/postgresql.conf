# PostgreSQL Production Configuration for UrGood
# Optimized for mental health app workload

# =============================================================================
# CONNECTION SETTINGS
# =============================================================================
listen_addresses = '*'
port = 5432
max_connections = 200
superuser_reserved_connections = 3

# =============================================================================
# MEMORY SETTINGS
# =============================================================================
shared_buffers = 256MB                 # 25% of RAM for small instances
effective_cache_size = 1GB             # Estimate of OS cache
work_mem = 4MB                         # Memory for sorts/joins per connection
maintenance_work_mem = 64MB            # Memory for maintenance operations
dynamic_shared_memory_type = posix

# =============================================================================
# WRITE AHEAD LOG (WAL) SETTINGS
# =============================================================================
wal_level = replica                    # Enable replication
wal_buffers = 16MB                     # WAL buffer size
checkpoint_completion_target = 0.9     # Spread checkpoints over time
checkpoint_timeout = 10min             # Maximum time between checkpoints
max_wal_size = 2GB                     # Maximum WAL size before checkpoint
min_wal_size = 1GB                     # Minimum WAL size

# =============================================================================
# QUERY PLANNER SETTINGS
# =============================================================================
random_page_cost = 1.1                 # Cost of random page access (SSD optimized)
effective_io_concurrency = 200         # Concurrent I/O operations (SSD)
default_statistics_target = 100        # Statistics collection target

# =============================================================================
# LOGGING SETTINGS
# =============================================================================
log_destination = 'stderr'
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_min_duration_statement = 1000      # Log slow queries (>1s)
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on
log_statement = 'all'                  # Log all statements (adjust for production)
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '

# =============================================================================
# PERFORMANCE MONITORING
# =============================================================================
shared_preload_libraries = 'pg_stat_statements'
track_activities = on
track_counts = on
track_io_timing = on
track_functions = all

# =============================================================================
# AUTOVACUUM SETTINGS (Important for mental health data)
# =============================================================================
autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 1min
autovacuum_vacuum_threshold = 50
autovacuum_analyze_threshold = 50
autovacuum_vacuum_scale_factor = 0.2
autovacuum_analyze_scale_factor = 0.1

# =============================================================================
# SECURITY SETTINGS
# =============================================================================
ssl = on
ssl_cert_file = '/etc/ssl/certs/server.crt'
ssl_key_file = '/etc/ssl/private/server.key'
ssl_ciphers = 'HIGH:MEDIUM:+3DES:!aNULL'
ssl_prefer_server_ciphers = on
password_encryption = scram-sha-256

# =============================================================================
# TIMEZONE AND LOCALE
# =============================================================================
timezone = 'UTC'
log_timezone = 'UTC'
datestyle = 'iso, mdy'
default_text_search_config = 'pg_catalog.english'

# =============================================================================
# CONNECTION POOLING PREPARATION
# =============================================================================
tcp_keepalives_idle = 600             # TCP keepalive settings
tcp_keepalives_interval = 30
tcp_keepalives_count = 3

# =============================================================================
# MENTAL HEALTH APP SPECIFIC OPTIMIZATIONS
# =============================================================================
# Optimize for read-heavy workload with frequent small writes
seq_page_cost = 1.0                   # Sequential scan cost
cpu_tuple_cost = 0.01                 # CPU cost per tuple
cpu_index_tuple_cost = 0.005          # CPU cost per index tuple
cpu_operator_cost = 0.0025            # CPU cost per operator

# Enable parallel queries for analytics
max_parallel_workers_per_gather = 2
max_parallel_workers = 4
max_worker_processes = 8

# Optimize for session data and chat history
temp_buffers = 8MB                    # Temporary buffer size
max_prepared_transactions = 0         # Disable 2PC (not needed)

# =============================================================================
# BACKUP AND RECOVERY
# =============================================================================
archive_mode = on
archive_command = 'cp %p /backups/wal/%f'
max_wal_senders = 3                   # For streaming replication
wal_keep_size = 1GB                   # Keep WAL files for replication
